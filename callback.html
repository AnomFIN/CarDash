<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Callback - CarDash</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            max-width: 500px;
            padding: 40px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3e7bfa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message {
            font-size: 1.2rem;
            margin-top: 20px;
        }
        .error {
            color: #ff4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <div class="message" id="message">Käsitellään Spotify-kirjautumista...</div>
    </div>

    <script>
        /**
         * Spotify OAuth Callback Handler
         * Käsittelee Spotifyn palauttaman access tokenin
         */
        
        function handleCallback() {
            const messageEl = document.getElementById('message');
            
            // Tarkista onko hash-parametrit olemassa (implicit grant flow)
            const hash = window.location.hash.substring(1);
            
            if (!hash) {
                messageEl.textContent = 'Ei kirjautumistietoja. Palaa takaisin CarDash-sovellukseen.';
                messageEl.classList.add('error');
                setTimeout(() => {
                    window.close();
                }, 3000);
                return;
            }
            
            // Parsee hash-parametrit
            const params = {};
            hash.split('&').forEach(part => {
                const [key, value] = part.split('=');
                params[key] = decodeURIComponent(value);
            });
            
            const accessToken = params.access_token;
            const expiresIn = params.expires_in;
            
            if (accessToken) {
                // Tallenna token localStorage:en
                const tokenData = {
                    accessToken: accessToken,
                    expiresIn: expiresIn,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('spotify-token', JSON.stringify(tokenData));
                
                messageEl.textContent = '✓ Kirjautuminen onnistui! Palaa takaisin CarDash-sovellukseen.';
                
                // Sulje ikkuna 2 sekunnin kuluttua
                setTimeout(() => {
                    // Jos tämä on popup, sulje se
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'spotify-auth-success',
                            token: accessToken
                        }, window.location.origin);
                        window.close();
                    } else {
                        // Jos ei popup, ohjaa takaisin pääsivulle
                        window.location.href = '/';
                    }
                }, 2000);
            } else {
                messageEl.textContent = 'Kirjautuminen epäonnistui. Yritä uudelleen.';
                messageEl.classList.add('error');
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        }
        
        // Käynnistä callback-käsittely
        handleCallback();
    </script>
</body>
</html>
